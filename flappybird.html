<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Flappy Bird</title>
    <link rel="stylesheet" href="flappybird.css">
</head>
<body>
    <div id="Background">
        <div id="Bird"></div>
        <div class="Pipes">
            <ul id="Pipes" class="clearfix">
                <li><div></div></li>
                <li><div></div></li>
                <li><div></div></li>
                <li><div></div></li>
                <li><div></div></li>
            </ul>
        </div>
        <ul id="Grounds" class="clearfix">
            <li></li>
            <li></li>
            <li></li>
        </ul>
    </div>
    <div hidden="hidden">
        <audio id="Hit" src="Sounds/Hit.wav"></audio>
        <audio id="Wing" src="Sounds/Wing.wav"></audio>
    </div>
    <script type="text/javascript">
        //<![CDATA[
        var time = null, speedY = 0, posY = 200, a = -6;
        var bird = document.getElementById("Bird"), birdStyle = bird.style;
        var Hit = document.getElementById("Hit"), Wing = document.getElementById("Wing");

        function game_over() {
            var groundsStyle = document.getElementById("Grounds").style;
            groundsStyle.webkitAnimationPlayState = groundsStyle.mozAnimationPlayState = groundsStyle.animationPlayState = "paused";
            birdStyle.webkitAnimationPlayState = birdStyle.mozAnimationPlayState = birdStyle.animationPlayState = "paused";
            var pipes = document.querySelectorAll("#Pipes > li");
            for (var i = 0; i < pipes.length; ++i) {
                var pipeStle = pipes.item(i).style;
                pipeStle.webkitAnimationPlayState = pipeStle.mozAnimationPlayState = pipeStle.animationPlayState = "paused";
            }
            document.removeEventListener("keypress", jump);
        }

        function jump() {
            speedY = 30;
            // TODO: IE
            Wing.currentTime = 0;
            Wing.play();
        }

        function removePipe() {
            var nextPipe = this.nextElementSibling;
            var Pipes = this.parentNode;
            Pipes.removeChild(this);
            Pipes.appendChild(document.createElement("li"));
            nextPipe.classList.add("moving");
            nextPipe.addEventListener("transitionend", removePipe);
        }

        function go(timestamp) {
            if (time === null) {
                time = timestamp;
                var pipes = document.querySelectorAll("#Pipes > li");
                for (var i = 0; i < pipes.length; ++i) {
                    var pipe = pipes.item(i);
                    pipe.style.top = (-Math.random() * 350 - 100) + "px";
                    pipe.addEventListener("webkitAnimationIteration", function () {
                        this.style.top = (-Math.random() * 350 - 50) + "px";
                    });
                }
            }
            var t = (timestamp - time) / 100;
            posY -= speedY * t + a * t * t / 2;
            if (posY < -8) {
                posY = -8;
                speedY = 0
            } else if (posY > 455) {
                bird.style.top = "456px";
                Hit.play();
                game_over();
                return;
            }
            speedY += a * t;
            birdStyle.webkitTransform = birdStyle.transform = "rotate(" + (-speedY) + "deg)";
            birdStyle.top = posY + "px";
            time = timestamp;
            window.requestAnimationFrame(go);
        }

        (function() {
            window.requestAnimationFrame(go);
            document.addEventListener("keypress", jump);
        })();
        //]]>
    </script>
</body>
</html>
